<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" href="css/themes.css">
		<link rel="stylesheet" href="css/uPlot.min.css">
		<link rel="stylesheet" href="css/tab.css">
		<style media="screen">
			.graph {
				--font: DejaVu Sans Mono, Liberation Mono, monospace;
				background-color: var(--color-bg);
				color: var(--color-text);
				font-family: var(--font);
				font-size: 14px;
				margin: 8px 2px 0 0;
			}
			.u-series, .u-value, .u-title {
				font-family: var(--font);
			}
			#updated {
				font-style: italic;
				color: var(--color-grid);
				position: absolute;
				left: 32px;
				bottom: 45px;
			}
		</style>
		<title>Circles</title>
	</head>
	<body main-theme="dark" class="graph">
		<span id="updated">Loading..</span>
		<script type="module">
			import {receiveData} from './js/applications/circles.js';
			import {constructQueryManager} from './js/lib/util.js';
			const opts = new Proxy(new URLSearchParams(window.location.search), {
				get: (searchParams, prop) => searchParams.get(prop),
			});
			if (opts.bg)
				document.body.style.backgroundColor = '#' + opts.bg;
			const days = parseInt(opts.days) || 7;
			let updateDelay = parseInt(opts.update) || 30;
			if (updateDelay < 5) updateDelay = 5;
			const delayMs = updateDelay * 60 * 1000;
			let updated;
			const updt = document.getElementById('updated');
			const query = constructQueryManager('api/neutron/circles', {
				data: resp => {
					updated = Date.now();
					updt.innerHTML = `Updated just now`;
					receiveData(resp);
					setInterval(() => {
						const sec = (Date.now() - updated) / 1000;
						if (sec < 60)
							updt.innerHTML = `Updated ${sec.toFixed()} second${sec<2?'':'s'} ago`;
						else
							updt.innerHTML = `Updated ${Math.floor(sec/60)} minute${sec<120?'':'s'} ago`;
					}, 1000);
				}
			}, false, true);
			function fetch() {
				const params = {
					from: Math.floor(new Date().getTime() / 1000 - 86400 * days),
					to:   Math.floor(new Date().getTime() / 1000),
				};
				updt.innerHTML = `Updating...`;
				query.fetch(params);
				const nextUpdate = Math.ceil(Date.now() / delayMs) * delayMs + 60000
				console.log('next in ', (nextUpdate - Date.now()) / 1000)
				setTimeout(fetch, nextUpdate - Date.now());
			}
			fetch();
		</script>

	</body>
</html>
